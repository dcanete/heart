---
title: 'Práctica 2: ¿Cómo realizar la limpieza y análisis de datos?'
author: "Balpreet Kaur Singh/Daniel Cañete Román"
tuthor: "María Isabel Guitart Hormigo"
date: '`r format(Sys.Date(),"%e de %B %Y")`'
output:
  html_document:
    toc: yes
#    number_sections: yes
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Planificación

Trabajamos por GIT.

**Antes 28/5**. Reunión 17:00: Dani prepara rdm con esquema y notas de qué hacer en cada apartado.

**Desde reunión hasta 2/6.** Balpreet rellena el rmd con notas, avanzando sobretodo en el código fuente. Reunión sincro 17:00 -\> No celebrada

**Desde reunión hasta 4/6**. Dani revisa textos y avances de Bapreet, incluyendo propuestas de cambio. Reunión sincro 17:00

**Desde reunión hasta 7/6**. Balpreet rellena el rmd con notas, avanzando sobretodo en el código fuente. En la reunión debemos planificar la grabación del vídeo. Reunión sincro 17:00

**Desde reunión hasta 8/6**. Dani hace un repaso dejando cerrado el rdm. Genera html, prepara carpetas, ...

**12-16/6**. (pendiente de planificar) Grabación de vídeo.

Nota: hay mucho código que se puede utilizar de ejemplo: <https://www.kaggle.com/datasets/rashikrahmanpritom/heart-attack-analysis-prediction-dataset/code?datasetId=1226038&sortBy=voteCount&language=R>

Nota2: Hay pasos muy similares a la asignatura de minería de datos. He compartido mis PEC del semestre pasado.

# 0. Introdución y pasos iniciales

Esta práctica se ha realizado bajo el contexto de la asignatura **Tipología y ciclo de vida de los datos**, perteneciente al Máster en Ciencia de Datos de la Universitat Oberta de Catalunya. En ella, se aplican técnicas de **limpieza y análisis de datos** mediante el lenguaje de programación R.

Para facilitar la lectura se incorpora parte del enunciado utilizando el formato blockquote

Tras analizar el dataset resultante en la PRA1, se ha seleccionado el propuesto en el enunciado por tener mayor riqueza a nivel educativo.

Antes de empezar con los apartados propuestos en el enunciado de la PRA, se realizan pasos previos necesarios: carga de datos y librerías utilizadas:

```{r load_libraries, include=FALSE}
# Librerías que se utilizan en el código
if(!require('gt')) {install.packages('gt'); library('gt')}
if(!require("corrplot")) install.packages("corrplot"); library("corrplot")
if(!require("dplyr")) install.packages("dplyr"); library("dplyr") 
if(!require("ggplot2")) install.packages("ggplot2"); library("ggplot2")
if(!require("ggpubr")) install.packages("ggpubr"); library("ggpubr")
if(!require("gridExtra")) install.packages("gridExtra"); library("gridExtra")
if(!require("EnvStats")) install.packages("EnvStats"); library("EnvStats")
if(!require("car")) install.packages("car"); library("car")
if(!require("ggcorrplot")) install.packages("ggcorrplot"); library("ggcorrplot")

# Cargamos los datos
ds<-read.csv("heart.csv")
```

# 1. Descripción del dataset

> ¿Por qué es importante y qué pregunta/problema pretende responder?

En primer lugar, se estudia la documentación disponible en <https://www.kaggle.com/datasets/rashikrahmanpritom/heart-attack-analysis-prediction-dataset> donde se puede apreciar:

-   Se trata de un estudio ataques al corazon donde existen datos de de problemas de corazón donde se

-   Licencia [CC0: Public Domain](https://creativecommons.org/publicdomain/zero/1.0/). Sin copyright, lo cual nos habilita a utilizarlo sin problemas.

-   El dataset tiene las siguientes columnas:

    -   Age: Edad del paciente

    -   Sex : Sexo del paciente

    -   exang: angina inducida por el ejercicio (1 = sí; 0 = no)

    -   ca: número de venas principales

    -   cp : Tipo de dolor torácico

        -   Valor 1: angina típica

        -   Valor 2: angina atípica

        -   Valor 3: dolor no anginoso

        -   Valor 4: asintomático

    -   trtbps: presión arterial en reposo (en mm Hg)

    -   chol: colesterol en mg/dl obtenido a través del sensor BMI

    -   fbs: azúcar en sangre en ayunas \> 120 mg/dl (1 = verdadero; 0 = falso)

    -   rest_ecg : resultados electrocardiográficos en reposo

        -   Valor 0: normal

        -   Valor 1: tener anomalías en la onda ST-T (inversiones de la onda T y/o elevación o depresión del ST \> 0,05 mV)

        -   Valor 2: mostrar hipertrofia ventricular izquierda probable o definitiva según los criterios de Estes

    -   thalach: frecuencia cardíaca máxima alcanzada
    
    - slp: se refiere a la pendiente de una línea de tendencia trazada en un gráfico.

    -   target: 0= menos posibilidades de ataque al corazón 1= más posibilidades de ataque al corazón

Corroboremos estos datos e indaguemos un poco más:

```{r}
head(ds) %>% gt()
summary (ds)
str(ds)
print ("Valores ausentes:")
colSums(is.na(ds))
print("Cadenas vacías")
colSums(ds=="")
print (paste (nrow(ds) , " observaciones")) 
print ("Valores diferentes de cp: ")
unique (ds$cp)
print ("Valores diferentes de restecg: ")
unique (ds$restecg)
print ("Valores diferentes de slp: ")
unique (ds$slp)
print ("Valores diferentes de caa: ")
unique (ds$caa)
print ("Valores diferentes de thall: ")
unique (ds$thall)
print ("Valores diferentes de sex: ")
unique (ds$sex)
print ("Valores diferentes de fbs: ")
unique (ds$fbs)
print ("Valores diferentes de exng: ")
unique (ds$exng)

```

Hay 303 observaciones, inicialmente no hay valores ausentes. Respecto los 0, estos son valores aceptables entre los valores disponibles de atributo. Es decir, los valores "0" no significan ausencia de valor para el atributo especifico.

Los campos no son exactamente como aparece en la documentación, pero se puede encontrar una descripción más actualizada en <https://www.kaggle.com/code/namanmanchanda/heart-attack-eda-prediction-90-accuracy>:

+------------+------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------+
| Campo      | Descripción                                                                                                            | Tipo                                              |
+============+========================================================================================================================+===================================================+
| age        | Edad del paciente                                                                                                      | int (29-77)                                       |
+------------+------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------+
| sex        | Sexo del paciente                                                                                                      | int (0 ó 1). No se indica qué significa cada cuál |
+------------+------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------+
| cp         | Tipo de dolor torácico                                                                                                 | int (0, 1, 2 ó 3)                                 |
|            |                                                                                                                        |                                                   |
|            | -   Valor 1: angina típica                                                                                             |                                                   |
|            |                                                                                                                        |                                                   |
|            | -   Valor 2: angina atípica                                                                                            |                                                   |
|            |                                                                                                                        |                                                   |
|            | -   Valor 3: dolor no anginoso                                                                                         |                                                   |
|            |                                                                                                                        |                                                   |
|            | -   Valor 4: asintomático                                                                                              |                                                   |
+------------+------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------+
| trtbps     | Presión arterial en reposo (en mm Hg)                                                                                  | int (94-200)                                      |
+------------+------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------+
| chol       | Colesterol en mg/dl obtenido a través del sensor BMI                                                                   | int (126-564)                                     |
+------------+------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------+
| fbs        | Azúcar en sangre en ayunas \> 120 mg/dl (1 = verdadero; 0 = falso)                                                     | int (0 ó 1)                                       |
+------------+------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------+
| restecg    | Electrocardiograma en reposo                                                                                           | int (0, 1 ó 2)                                    |
|            |                                                                                                                        |                                                   |
|            | -   Valor 0: normal                                                                                                    |                                                   |
|            |                                                                                                                        |                                                   |
|            | -   Valor 1: tener anomalías en la onda ST-T (inversiones de la onda T y/o elevación o depresión del ST \> 0,05 mV)    |                                                   |
|            |                                                                                                                        |                                                   |
|            | -   Valor 2: mostrar hipertrofia ventricular izquierda probable o definitiva según los criterios de Estes              |                                                   |
+------------+------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------+
| thalachh   | Frecuencia cardíaca máxima alcanzada                                                                                   | int (71-202)                                      |
+------------+------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------+
| exng       | Angina inducida por el ejercicio (1 = sí; 0 = no)                                                                      | int (0 ó 1)                                       |
+------------+------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------+
| oldpeak    | Pico anterior                                                                                                          | num (0-6.2)                                       |
+------------+------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------+
| slp        | Tendency Slope. Se refiere a la pendiente de una línea de tendencia.                                  | int (0, 1 ó 2)                                    |
+------------+------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------+
| caa        | Número de venas principales                                                                                            | int (0, 1, 2, 3 ó 4)                              |
+------------+------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------+
| thall      | Resultado de la prueba de esfuerzo con talio. Esta prueba es para comprobar si el flujo sanguineo a traves de las arterias coronarias es normal o no. | int (0, 1, 2 ó 3)                                 |
+------------+------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------+
| output     | Variable objetivo. Es una codificación, no se define el significado de cada valor. Pero asumimos que :                           | int (0 ó 1)                                       |
|            |                                                                                                                        |                                                   |
|            | -   0, no predispuesto a tener ataque cardiaco                                                                                                |                                                   |
|            |                                                                                                                        |                                                   |
|            | -   1, predispuesto  a tener ataque cardiaco                                                                                                    |                                                   |
+------------+------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------+

Vemos que tenemos:

-   Una variable objetivo categórica: output

-   Variables categóricas: sex, cp, fbs, restecg, exng, slp, caa y thall

-   Variables numéricas: age, trtbps, chol, thalachh y oldpeak

**¿Por qué es importante y qué pregunta/problema pretende responder?**

Ahora conocemos un poco mejor los datos, podemos responder a la pregunta. Se trata de un dataset con información clínica de pacientes que están predispuestos o no a tener una angina de pecho. Evidentemente es muy interesante para crear un modelo predictivo, pero también para conocer qué variables hacen que una persona tenga más posibilidades de padecer una angina de pecho.

**Nota**: Hay algunos campos que no conocemos su significado concreto, pero aún así se pueden utilizar para el modelo. Si se detectan que son variables relacionadas con la variable objetivo, un experto puede describir su significado.

# 2. Integración y selección

> Integración y selección de los datos de interés a analizar. Puede ser el resultado de adicionar diferentes datasets o una subselección útil de los datos originales, en base al objetivo que se quiera conseguir.


La muestra no tiene un número elevado de registros que puedan dar problemas en el rendimiento en computación de analisis. En caso de que si la hubiera, habría que ver alguna manera de limitar los datos, al menos para facilitar los cálculos en fase de desarrollo (por ejemplo, limitar los atributos mediante PCA). 

Respecto las observaciones y los datos en general, cuanto mayor observaciones tengamos, mejor nos acercaremos a los resultados y concluciones reales. Pero en nuestro caso, la muestra es pequeña. Por tanto, debemos de estudiar la muestra disponible para sacar las mejores conclusiones posibles.

Organizamos y buscamos duplicados:

```{r}
# Cambio de tipo variables clasificatorias
ds$sex <- as.factor(ds$sex)
ds$cp <- as.factor(ds$cp)
ds$fbs <- as.factor(ds$fbs)
ds$restecg <- as.factor(ds$restecg)
ds$exng <- as.factor(ds$exng)
ds$slp <- as.factor(ds$slp)
ds$caa <- as.factor(ds$caa)
ds$thall <- as.factor(ds$thall)
ds$output <- as.factor(ds$output)

# Cambio de variables numericas
ds$age <- as.numeric (ds$age)
ds$trtbps <- as.numeric (ds$trtbps)
ds$chol <- as.numeric (ds$chol)
ds$thalachh <- as.numeric (ds$thalachh)
ds$oldpeak <- as.numeric (ds$oldpeak)

# Ordenación de los campos (objetivo, clasificatorias y numéricas)
ds <- ds [, c ("output", "sex", "cp", "fbs", "restecg", "exng", "slp", "caa", "thall", "age", "trtbps", "chol", "thalachh", "oldpeak")]

# Comprobamos y quitamos los duplicados:
print(paste ("Duplicados:", nrow(ds[duplicated(ds), ]), "duplicados"))
ds<-ds[!duplicated(ds), ]
print(paste ("Duplicados despues de limpieza:", nrow(ds[duplicated(ds), ]), "duplicados"))

```

Se considera poco probable que haya dos observaciones exactamente iguales y, aunque en un caso real sería recomendable que lo valorase un experto, se ha supuesto una errata a la hora de crear el dataset y se ha eliminado la observación repetida.

Vamos a estudiar un poco más los campos categóricos comparándolos con la variable objetivo:

```{r}
myHistCat <- function(campo) {
  myPlot <- ggplot(ds, aes(x=ds[,campo], fill = output)) +
    geom_bar() + labs(x = campo, y = "Observaciones") +
    guides(fill = guide_legend(title = "")) +
    scale_fill_manual(values = c("black", "#008000")) +
    theme(axis.text.x = element_text(angle = 10, vjust = 1, hjust=0.5)) 
  return (myPlot)
}

grid.arrange(myHistCat("output"), myHistCat("sex"), myHistCat("cp"), 
             myHistCat("fbs"), myHistCat("restecg"), myHistCat("exng"), 
             myHistCat("slp"), myHistCat("caa"), myHistCat("thall"),
             ncol = 3, nrow = 3)

```

Sorprende que hay más personas predispuestas de las que no (164/138). Eso hace pensar que **la muestra está sesgada**, seguramente se ha obtenido entre pacientes que tenían alguna patología. Por eso se considera que **el estudio puede servir para detectar factores de riesgo, pero no se pueden sacar conclusiones a nivel de población general**,

Se observan también algunos valores posibles de variables con muy pocas observaciones, por lo que será difícil que sean significativos en un modelo predictivo. Este es el caso, por ejemplo:

-   4 venas principales en caa, donde hay solo 5 observaciones.

-   0 en la prueba de esfuerzo, donde hay solo dos observaciones.

-   2 en restecg (hipertrofia ventricular izquierda probable o definitiva según los criterios de Estes) donde solo hay 4 observaciones.

```{r}
for (i in 1:9) {
  vName <- names(ds)[i]
  print (vName)
  print (table(ds[,i], ds$output))
}
```

Viendo las tablas por cada variable, podemos observar lo siguiente:

-   sex: tenemos un total de 96 personas de sexo tipo "0" y 206 personas de sexo tipo "1". Y si pasamos a profundizar más en estos totales, podemos ver que tenemos 72 casos de los 96 que tienen ataque cardiaco. Y 92 casos de los 206 tienen ataque cardiaco.

-   cp: vemos que tenemos un total de 143 personas de cp tipo "0" (no padecen ningún tipo de Chest Pain listados), de los cuales 39 tienen ataque cardíaco. Después tenemos 50 personas de cp tipo "1" (los cuales padecen dolor típico de angina), entre los cuales 41 son personas que padecen ataque cardíaco. Tenemos 86 personas de sexo tipo "2" (los cuales padecen dolor no anginoso), entre los cuales 68 son personas que padecen ataque cardíaco. Y por último, de las 32 personas que padecen dolor de pecho son debido a dolores asintomático, solamente 16 padecen ataque cardíaco.

-   Visualizando la grafica y las cantidades numericas del sexo, vemos que tenemos un total de 96 personas de sexo tipo "0" y 206 personas de sexo tipo "1". Y si pasamos a profundizar más en estos totales, podemos ver que tenemos 72 casos de los 96 de Sexo "0" tienen ataque cardiaco.Y 92 casos de los 206 de Sexo "1" tienen ataque cardiaco.

-   fbs: el cual significa fasting blood sugar (glucemia en ayunas), podemos decir que 54,86% (141/(116+141)) de las personas no padecen glucemia en ayunas tiene ataque cardíaco. En cambio, el porcentaje de tener el ataque cardíaco baja a 51,11% (23/(22+23)) para las personas que padecen glucemia en ayunas. Y sumando las 2 categorías, tenemos que la probabilidad de tener ataque cardíaco es 54,3% ((141+23)/(302)) independientemente de si la persona ha tenido glucemia en ayunas o no. Por tanto, en resumen, las personas que no padecen glucemia en ayunas tienen mas probabilidad de tener un ataque cardíaco.

-   restecg: el cual significa resultados electrocardiográficos en reposo, podemos decir que 46,25% (68/(68+79)) de las personas que tienen un resultado electrocardiográficos en reposo NORMAL pueden padecer un ataque cardíaco. Y este porcentaje sube a 62,91% en el caso de personas con anomalía en la onda ST-T. Y es 25% la probabilidad de que una persona que muestra hipertrofia ventricular izquierda probable o definitiva según los criterios de Estes padezca un ataque cardíaco. Y sumando ((68+95+1)/(79+68+56+95+3+1)), como esperamos, hay una probabilidad de 54,3% de que una persona padezca un ataque cardíaco independientemente de tipo de resultados electrocardiográficos en reposo. En resumen, hay más probabilidad de que una persona con anomalía en la onda ST-T padezca un ataque cardíaco comparado a las 2 otros tipos de resultados electrocardiográficos en reposo. Y podemos decir de que es mas probable de una una persona con resultado NORMAL padezca un ataque cardíaco que una persona que muestre hipertrofia ventricular izquierda probable o definitiva según los criterios de Estes.

-   exng: que significa angina inducida por el ejercicio (exercise induced angina), podemos decir 69,45% de los casos de personas de tener angina no inducida por el ejercicio tienen ataque cardíaco. En cambio, si hablamos de personas con angina inducida por el ejercicio, este porcentaje de padecer el ataque cardíaco baja a 23%. Claramente analizamos que las personas con angina no inducida por el ejercicio es mas que doble de probable que la persona con angina inducida por ejercicio.

-   slp: podemos observar que las personas que cubran el "slope" tipo 0 tienen una probabilidad de 42,85% de sufrir el ataque cardíaco y las personas que cubren slope tipo "1" tiene una probabilidad de padecer el ataque cardíaco en un 35%. Las personas de slope tipo "2" tienen una probabilidad de 75,17% de tener el ataque cardíaco. Por tanto, Slope tipo "2" tiene más probabilidad de tener el ataque cardíaco en comparación a los otros 2 tipos y el slope tipo "1" es la que menos probabilidad.

-   caa: podemos decir que 74,28% para personas con 0 venas principales (major vessels) tienen ataque cardiaco, 32,3% para personas con 1 vena principal, 18,42% para personas con 2 venas principales, 15% para personas con 3 venas principales y 75% para personas con 4 venas principales.

-   thall: tenemos que hay 50% probable de que una persona con Thalium Stress Test result "0" padezca un ataque cardiaco, 33,33% para personas con resultado "1" de prueba de Thalium Stress, 78,18% para personas con resultado "2" de prueba de Thalium Stress y 23,93% para personas con resultado "3" de prueba de Thalium Stress.

Estudiemos los valores numéricos:

```{r}
myHistNum <- function(campo) {
  myPlot <- ggplot(ds, aes(ds[,campo], fill = output)) +
    geom_bar() + labs(x = campo, y = "Observ.") +
    guides(fill = guide_legend(title = "")) +
    scale_fill_manual(values = c("black", "#008000")) 
  return (myPlot)
}

grid.arrange(myHistNum("age"), myHistNum("trtbps"), myHistNum("chol"), 
             myHistNum("thalachh"), myHistNum("oldpeak"),
             ncol = 2, nrow = 3)

```

Al analizar las distribuciones en los histogramas, podemos decir que las observaciones son mas frecuentes cuando:

-   Picos anteriores (oldpeak) son más cercano a 0

-   Frecuencia cardiaca (thalachh) con valores superiores a 140 y inferiores a 180.

-   Presión arterial en reposo está entre 100 y 160 Hg.

-   Colesterol esta entre 150 y 350 mg/dl segun BMI sensor

-   Y edad entre 40 y 70 años.

Los histogramas presentados no nos permiten diferenciar comportamientos distintos dependiendo de la variable objetivo. Veamos en diagrams de cajas:

```{r}
myCaja <- function(campo) {
  myPlot <- ggplot(ds, aes(x=output, y=ds[,campo], fill=output)) +
    geom_boxplot(alpha=0.5) +
    labs(x = "output", y = campo) +
    theme(legend.position="none") 
  return (myPlot)
}

grid.arrange(myCaja("age"), myCaja("trtbps"), myCaja("chol"), 
             myCaja("thalachh"), myCaja("oldpeak"),
             ncol = 3, nrow = 2)
```

Se pueden intuir alguna correlación con la variable objetivo. Por ejemplo, parece que es más probable tener ataque al corazón (output = 1) cuando:

-   Picos anteriores (oldpeak) son más cercano a 0

-   Frecuencia cardiaca (thalachh) con valores entre 150y 170.

Estudiemos la correlación entre las variables. Si encontramos alguna muy relacionadas podemos quitarlas del modelo y reducir su complejidad:

```{r}
n = c("age", "trtbps", "chol", "thalachh", "oldpeak")
factores= ds %>% select(all_of(n))
res<-cor(factores)
corrplot(res,method="color",tl.col="black", tl.srt=30, order = "AOE",
number.cex=0.75,sig.level = 0.01, addCoef.col = "black")

matriz <- cor (ds[,n])
corrplot(matriz, type="upper", order="hclust", tl.col="black", tl.srt=45)

```

Observamos que no hay una alta correlación entre las variables por lo que no prescindiremos de ninguna.

# 3. Limpieza de los datos

> 3.1. ¿Los datos contienen ceros o elementos vacíos? Gestiona cada uno de estos casos
>
> 3.2. Identifica y gestiona los valores extremos

En el punto anterior se ha analizado el dataset y observando los resultados, ya podemos obtener algunas conclusiones sin necesidad de desarrollar más código:

-   **No se aprecian valores ausentes**. Asumiendo que los datos son recogidos sin errores alguno, podemos afirmar que no hay ausencia de valores ya estos se suelen identifcar con:

    -   "na" -\> No se encuentra dicha cadena en el dataset

    -   "0" -\> En el caso de estudio, la mayoría de las variables tiene un significado concreto para ese valor y son recolectador y/o insertados sin transformación previa alguna.

-   En los diagramas de cajas, vemos varios valores fuera de los rangos normales. Estos son valores extremos, pero no tienen por que ser erroneos (outliers), por lo que sería recomendable consultar a un experto antes de descartarlos. En nuestro caso entendemos todos como válidos excepto un caso que destaca: una **observación con extremadamente elevado, que está muy separada de los rangos normales**.

La gestión de valores atípicos (outlier management) es la ciencia de investigar y aplicar un tratamiento adecuado a los valores atípicos en los datos. Puede ser tentador simplemente eliminar los registros donde hay valores atípicos en el conjunto de datos, pero no siempre es el mejor enfoque. El método de tratamiento de valores atípicos puede variar de un caso a otro y debe discutirse con la empresa antes de finalizar el método. Existen diferentes enfoques, como **reemplazar el valor atípico con el valor medio o la mediana** o, en algunos casos, **descartar la observación con el valor atípico sospechoso para evitar cualquier sesgo en ellos**. Tendemos a eliminar los valores atípicos si se deben a errores de entrada de datos causados por errores humanos, errores de procesamiento de datos.

Vamos a gestionar el último valor extremo de Colestrol, del cual estamos seguros que es valor extremo inaceptable optando por sustituirlo por la media:

```{r}
max(ds$chol)
ds [ds$chol==max(ds$chol), ]

# El ultimo valor extremo de cholestrol lo sustituimos por la media al estar seguros de que es un valor outlier erroneo.
ds [ds$chol==max(ds$chol), ]$chol <- mean (ds$chol)
```

Con el siguiente código podríamos detectar otros valores extremos y candidatos a outliers. Como se ha comentado, lo ideal es revisar con un experto la estrategia a seguir:

```{r}
ds %>%
  arrange(desc(chol)) %>% 
  slice(1:8)
```

# 4. Análisis de los datos

## 4.1. Selección de los grupos de datos

> Selección de los grupos de datos que se quieren analizar/comparar (p. ej., si se van a comparar grupos de datos, ¿cuáles son estos grupos y qué tipo de análisis se van a aplicar?)

Teniendo en cuenta a **output como la variable objetivo**, procederemos a compararla con los diferentes atributos. En los siguientes puntos procederemos a hacer los comparaciones entre siguientes grupos y estrategias:

-   Output y atributos categóricos ['sex', 'cp', 'fbs', 'restecg','exng','slp', 'caa', 'thall']: tenemos **dos variables categóricas** y haremos un test de χ2 para ver si existen diferencias significativas entre los grupos definidos. Pero en nuestro caso, tenemos una **muestra pequeña**, por tanto, **usaremos Fisher Test**.

-   Output y variables numéricas nominal ['age', 'trtbps', 'chol', 'thalachh', 'oldpeak']: comparamos una **variable categórica con otra numérica**. La estrategia será distinta según:

    -   **si cumple normalidad y homocedasticidad con output -\> aplicamos tStudent,**

    -   **si no -\> test de Mann-Whitney.**

## 4.2. Comprobación de la normalidad y homogeneidad de la varianza.

Comprobamos la normalidad y homogeneidad de la varianza:

```{r}
ds$age %>% qqPlot(dist="norm", ylab = "Age")
ds$trtbps %>% qqPlot(dist="norm", ylab = "trtbps")
ds$chol %>% qqPlot(dist="norm", ylab = "chol")
ds$thalachh %>% qqPlot(dist="norm", ylab = "thalachh")
ds$chol %>% qqPlot(dist="norm", ylab = "oldpeak")
```

```{r}
shapiro.test(ds$age)
shapiro.test(ds$trtbps)
shapiro.test(ds$chol)
shapiro.test(ds$thalachh)
shapiro.test(ds$oldpeak)
```

Vemos que en todos los casos, el valor P es inferior a 0,05, lo que significa que **no podemos asumir normalidad en ninguno de las variables numéricas.**

Ahora veamos homogeneidad de varianza mediante Levene Test (no FTest) ya que no cumplimos el requisito de normalidad:

```{r}
leveneTest(age ~ output, data = ds)
leveneTest(trtbps ~ output, data = ds)
leveneTest(chol ~ output, data = ds)
leveneTest(thalachh ~ output, data = ds)
leveneTest(oldpeak ~ output, data = ds)
```

La prueba de Levene es una estadística inferencial utilizada para evaluar la igualdad de varianzas de una variable calculada para dos o más grupos. Para esta prueba, un valor p de menos de 0,05 indica que, de hecho, hay suficiente variación en la muestra para explicar las posibles diferencias de medias.

Cuando tenemos un valor de p por encima de 0.05 (nivel de significancia), podemos concluir que existe una no diferencia significativa entre las varianzas de la muestra probada y, por tanto nos encontramos con homogeniedad en la varianza. Según esto, nos encontramos con:

-   Homogeniedad de las varianzas: trtbps, chol

-   No homogeniedad de las varianzas: age, thalachh, oldpeak

Por tanto, **incumplimos la asunciones de que el dataset sea normal y tenga homogeneidad de varianza.**



## 4.3. Aplicación de pruebas estadísticas para comparar los grupos de datos.

> En función de los datos y el objetivo del estudio, aplicar pruebas de contraste de hipótesis, correlaciones, regresiones, etc. Aplicar al menos tres métodos de análisis diferentes.

### Fisher test

Debido a que tenemos un dataset pequeño (\<1000) y ya hemos visto que no podemos asegurar normalidad, tenemos que utilizar fisher test para analizar la correlacion entre variables en vez de **Chi-cuadrado.**

Dado que vamos a hacer el mismo proceso con todas las variables clasificadoras, hacemos una función para facilitar código legible:

```{r}
myFishertest <- function (campo) {
  counts <- table(ds$output, ds[,campo])
  print (campo)
  print (counts / rowSums(counts))
  print (fisher.test(counts))
}
```

Este método nos ofrece una tabla de frecuencias y el resultado del test de fisher que puede sacar conclusiones sobre la tabla.

Si el resultado del fisher test nos da un p-value por debajo de su nivel de significación (p. ej., 0,05), se rechaza la hipótesis nula, o sea, que hay relación entre las variables.

Aplicamos el método con todas las variables categóricas:

```{r}
myFishertest ("sex")
myFishertest ("cp")
myFishertest ("fbs")
myFishertest ("restecg")
myFishertest ("exng")
myFishertest ("slp")
myFishertest ("caa")
myFishertest ("thall")
myFishertest ("output")
```
Cuando su valor p esté por debajo de su nivel de significación (p. ej., 0,05), rechace la hipótesis nula. Los datos de la muestra son lo suficientemente fuertes como para concluir que existe una relación entre las variables categóricas en la población. Conocer el valor de una variable proporciona información sobre el valor de la otra variable.

A continuación, se resume las conclusiones obtenidas en la siguiente tabla:

+---------+-------------+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|         | **p-value** | **Relaci-onadas** | **Tabla de frecuencias**                                                                                                                                                    |
+---------+-------------+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| sex     | = 1.01e-06  | Sí                | Podemos ver que el 43,9% de sexo "0" tuvieron heart attack, por debajo del sexo "1" con probabilidad de 56,09%. Tambien, gracias al test, podemos confirmar que la variable sexo afecta a la variable dependiente output.                                                             |
+---------+-------------+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| cp      | \< 2.2e-16  | Sí                | Rechazamos la hipótesis nula y confirmamos de que la probabilidad de tener un ataque es más alto en cp=2 teniendo en consideración la grafica y estadísticas anteriores.Tambien, gracias al test Fisher, podemos confirmar que la variable cp afecta a la variable dependiente output.    |
+---------+-------------+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| fbs     | = 0.746     | No                | No rechazamos la hipótesis nula y, por tanto, los diferentes tipos de cps tienen más o menos la misma probabilidad de tener un ataque infarto. Tambien, gracias al test Fisher, podemos confirmar que la variable fbs no afecta a al output de la variable dependiente.                             |
+---------+-------------+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| restecg | = 0.004462  | Sí                | Rechazamos la hipótesis nula y confirmamos de que la probabilidad de tener un ataque es más alto en restecg=1 teniendo en cuenta la gráfica y estadísticas anteriores. \|   | Tambien, gracias al test Fisher, podemos confirmar que la variable restecg afecta a la variable dependiente output.
+---------+-------------+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| exng    | = 3.438e-14 | Sí                | Rechazamos la hipótesis nula y confirmamos de que la probabilidad de tener un ataque es más alto en exng=0 teniendo en cuenta la gráfica y las estadísticas anteriores. \|  |Tambien, gracias al test Fisher, podemos confirmar que la variable exng afecta a la variable dependiente output.
+---------+-------------+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| slp     | = 1.769e-11 | Sí                | Rechazamos la hipótesis nula y confirmamos de que la probabilidad de tener un ataque es más alto en slp=2 teniendo en cuenta la gráfica y las estadísticas anteriores. \|   |Tambien, gracias al test Fisher, podemos confirmar que la variable slp afecta a la variable dependiente output.
+---------+-------------+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| caa     | \< 2.2e-16  |       Sí            | Rechazamos la hipótesis nula y confirmamos de que la probabilidad de tener un ataque es más alto en caa=0 teniendo en cuenta la gráfica y las estadísticas anteriores. \|   |Tambien, gracias al test Fisher, podemos confirmar que la variable caa afecta a la variable dependiente output.
+---------+-------------+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| thall   | \< 2.2e-16  | Sí                | Rechazamos la hipótesis nula y confirmamos de que la probabilidad de tener un ataque es más alto en thall=2 teniendo en cuenta la gráfica y las estadísticas anteriores. \| |Segun Fisher test, podemos decir que la variable thall afecta a la variable output.
+---------+-------------+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| output  | \< 2.2e-16  | Sí                | Rechazamos la hipótesis nula, como era de esperar ya que comparamos la misma variable\|        
+---------+-------------+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

### Whitney

Ahora vamos a estudiar los atributos numéricos versus el output mediante mediante Whitney Wilcoxon Rank sum Test.

```{r}
str(ds[10:14])
wilcox.test(age ~ output, data=ds) 
wilcox.test(trtbps ~ output, data=ds) 
wilcox.test(chol ~ output, data=ds) 
wilcox.test(thalachh ~ output, data=ds) 
wilcox.test(oldpeak ~ output, data=ds) 
```

Con un nivel de significancia de .05, rechazamos hipótesis nula y podemos concluir que todos los atributos numéricos y la salida en el conjunto de datos provienen de poblaciones no idénticas. También que la diferencia entre la media de la población de salida y el atributo numérico correspondiente es estadísticamente significativa. 

### Análisis de componentes principales

```{r warning=FALSE}

numerical_data <- ds[10:14]
data_normalized <- scale(numerical_data)
corr_matrix <- cor(data_normalized)
ggcorrplot(corr_matrix)
```

```{r}
data.pca <- princomp(corr_matrix)
summary(data.pca)
```

Los resultados anteriores muestran cuán importantes son estos 4 componentes de PCA considerando lo siguiente:

-   El componente 1 explica el 57,70% de la varianza total.
-   El componente 2 explica el 18,87% de la varianza total.
-   El componente 3 explica el 14,56% de la varianza total.
-   El componente 4 explica el 8,56% de la varianza total.

Extra: es genial tener los primeros 4 componentes, pero ¿qué significan realmente? Esto se puede responder explorando cómo se relacionan con cada columna utilizando las cargas de cada componente principal.

```{r}
data.pca$loadings[, 1:4]
```

¿Cómo interpretamos estos resultados? Por ejemplo, centrándonos en el Componente 1, debemos mencionar que el atributo "thalachh" impacta negativamente en el PCA y los otros factores de forma positiva. Y el mismo enfoque se aplica a los otros componentes.

# 5. Representación de los resultados

> Representación de los resultados a partir de tablas y gráficas. Este apartado se puede responder a lo largo de la práctica, sin necesidad de concentrar todas las representaciones en este punto de la práctica.

En el desarrollo del ejercicio se han ido utilizando diagramas representativos. Para seleccionar los más interesantes en cada caso, se ha utilizado como referencia la siguiente url: <https://www.data-to-viz.com/>

# 6. Resolución del problema

> A partir de los resultados obtenidos, ¿cuáles son las conclusiones? ¿Los resultados permiten responder al problema?

En base a los resultados antes expuestos, tenemos las siguientes conclusiones. Tenemos más probabilidad de tener un caso de ataque cardíaco:

-   Sexo 0 tiene más probabilidad de tener un ataque cardíaco.

-   Cp tipo 2 tiende a tener más probabilidad de ataque cardíaco.

-   Fbs con anomalía en la onda ST-T tiene 62% de probabilidad de tener el ataque cardíaco.

-   Respecto variable angina inducida por el ejercicio (exng), podemos decir 69,45% de los casos de personas de tener angina no inducida por el ejercicio tienen ataque cardiaco. Este baja a 23% cuando el ataque cardíaco es debido a angina inducida por el ejercicio.

-   Slope tipo "2" tiene más probabilidad de tener el ataque cardíaco.

-   Respecto la caa, personas con 0 venas principales tienen más probabilidad de tener el ataque cardiaco.

-   Respecto thall, decir que personas con resultado "2" de prueba de Thalium Stress tiene una probabilidad de 78,18% de tener el ataque cardiaco.

Y es más probable tener ataque al corazón (output = 1) cuando:

-   Picos anteriores (oldpeak) son más cercano a 0

-   Frecuencia cardiaca (thalachh) con valores entre 150y 170.

-   Presión arterial en reposo está entre 100 y 140 Hg.

-   Colesterol esta entre 205 y 265 mg/dl según BMI sensor

-   Y edad entre 45 y 59 años.

Después de comprobar qqtest, shapiro test y levene test comprobamos que incumplimos la asunciones de que el dataset sea normal y tenga homogeneidad de varianza.

Después de hacer Fisher Test, pudimos comprobar que los datos de la muestra son lo suficientemente fuertes como para concluir que existe una relación entre las variables categóricas en la población. Y conocer el valor de una variable proporciona información sobre el valor de la otra variable.

Respecto las variables numéricas y mediante el Whitney Test, pudimos comprobar que todos los atributos numéricos y la salida en el conjunto de datos provienen de poblaciones no idénticas. Podemos concluir que la diferencia entre la media de la población de salida y el atributo numérico correspondiente es estadísticamente significativa.


```{r}
install.packages("tidymodels")
library(tidymodels)
heart.split <- initial_split(ds)
heart.train <- training(heart.split)
heart.test <- testing(heart.split)
#logistic regression having all the predictors.
heart.full <- glm(output~., data = heart.train, family = "binomial")
summary(heart.full)
```


```{r}
# set engine
heart_model <- logistic_reg() %>%
  set_engine("glm")

# create recipe
heart_recipe <- recipe(output ~., data = heart.train) %>%
  step_rm(fbs) %>%
  step_rm(age) %>%
  step_rm(chol) %>%
  step_zv(all_predictors())

# build work flow
heart_wflow <- workflow() %>%
  add_model(heart_model) %>%
  add_recipe(heart_recipe)

# fit training data through the work flow 
heart_fit <- heart_wflow %>%
  fit(data = heart.train)
heart.train.pred = predict(heart_fit, new_data = heart.train)

traincomp <- data.frame(heart.train$output, heart.train.pred)
colnames(traincomp) <- c("train.response", "train.prediction")

install.packages("pROC")
library(pROC)
heart.roc <- roc(response = ordered(traincomp$train.response), predictor = ordered(traincomp$train.prediction))

plot(heart.roc, print.thres = "best", main = "Receiver Operating Characteritic Technique Plot")
```

```{r}
print(auc(heart.roc))
```
```{r}
#Perform 5-fold cross validation
set.seed(470)
folds <- vfold_cv(heart.train, v=5)

heart_fit_rs <- heart_wflow %>%
  fit_resamples(folds)

metrics <- data.frame(collect_metrics(heart_fit_rs, summarize = FALSE))

metrics <- metrics %>%
  select(-.config)
colnames(metrics) <- c("Fold", "Metric", "Estimator", "Estimate")
metrics
```
```{r}
heart.test.pred = predict(heart_fit, new_data=heart.test, type="response")

y_pred_num <- ifelse(heart.test.pred > 0.5, 1, 0)
y_pred <- factor(y_pred_num, levels=c(0, 1))
y_act <- testData$target

# Result : Prediction Accuracy (Proportion of predicted target that matches with actual target)
mean(y_pred == y_act)

```



```{R}
#Generate predictions on testing data
heart_disease_pred <- predict(heart_fit, new_data = heart.test) %>%
  bind_cols(heart.test %>% select(output))

test_accuracy <- accuracy(heart_disease_pred, truth = heart_disease, estimate = .pred_class)
test_specificity <- spec(heart_disease_pred, truth = heart_disease, estimate = .pred_class)
test_sensitivity <- sens(heart_disease_pred, truth = heart_disease, estimate = .pred_class)

test.values <- data.frame(test_accuracy$.estimate, test_sensitivity$.estimate, test_specificity$.estimate)
colnames(test.values) <- c("Test set Accuracy", "Test set Sensitivity", "Test set Specificity")
test.values
```

# 7. Código

> Hay que adjuntar el código, preferiblemente en R, con el que se ha realizado la limpieza, análisis y representación de los datos. Si lo preferís, también podéis trabajar en Python.

Disponible en este mismo fichero.

# 8. Vídeo

> Realizar un breve vídeo explicativo de la práctica (máximo 10 minutos), donde ambos integrantes del equipo expliquen con sus propias palabras el desarrollo de la práctica, basándose en las preguntas del enunciado para justificar y explicar el código desarrollado. Este vídeo se deberá entregar a través de un enlace al Google Drive de la UOC ([https://drive.google.com/...),](https://drive.google.com/…),) junto con enlace al repositorio Git entregado.

Se puede visualizar en cualquiera de estas dos alternativas:

-   Github: <https://github.com/dcanete/heart>

-   Drive: <https://drive.google.com/open?id=1gko9Vw2D3FQP5aewnnfp-hPio-AZ70KZ>
